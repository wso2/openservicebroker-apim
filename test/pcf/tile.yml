---
name: apim-service-broker
label: Generated Test Tile
description: A sample tile generated by tile-generator
icon_file: resources/wso2-logo.png
allow_paid_service_plans: true        # Allow paid service plans, default: false

stemcell_criteria:
    os: ubuntu-xenial
    requires_cpi: false
    version: '315.70'

properties:
  - name: author
    type: string
    label: Author
    value: Tile Ninja

forms:
  - name: db_form
    label: Database information
    description: Database information
    properties:
      - name: log_level
        type: dropdown_select
        label: Broker log level
        options:
          - name: info
            label: info
            default: true
          - name: debug
            label: debug
      - name: http_client_insecure_con
        type: boolean
        label: Enable insecure connections for HTTP client
      - name: http_client_timeout
        type: integer
        label: Timeout for HTTP client(s)
        default: 30
      - name: http_client_max_retries
        type: integer
        label: Max retires for HTTP client
        default: 3
      - name: http_client_min_back_off
        type: integer
        label: Minimum backoff time for HTTP client retries(s)
        default: 1
      - name: http_client_max_back_off
        type: integer
        label: Maximum backoff time for HTTP client retries(s)
        default: 60
      - name: broker_port
        type: integer
        label: Broker listening Port
        default: 8080
      - name: memory
        type: string
        label: Memory
        default: 256M
      - name: db_host
        type: string
        label: Database host
      - name: db_port
        type: integer
        label: Database port
        default: 3306
      - name: db_database_name
        type: string
        label: Database name
      - name: db_creds
        type: simple_credentials
        label: Database credentails
      - name: db_logmode
        type: boolean
        label: Enable database logging
packages:
  - name: apim_service_broker
    type: app-broker
    enable_global_access_to_plans: true
    manifest:
      path: ./servicebroker
      command: ./servicebroker
      memory: (( .properties.memory.value ))
      buildpack: binary_buildpack
      env:
        APIM_BROKER_LOG_LEVEL: (( .properties.log_level.value ))
        APIM_BROKER_HTTP_PORT: (( .properties.broker_port.value ))
        APIM_BROKER_APIM_TOKENENDPOINT: "https://gateway.sys.ixdev.wso2.com"
        APIM_BROKER_APIM_DYNAMICCLIENTENDPOINT: "https://keymanager.sys.ixdev.wso2.com"
        APIM_BROKER_APIM_STOREENDPOINT: "https://wso2apim.sys.ixdev.wso2.com"
        APIM_BROKER_APIM_PUBLISHERENDPOINT: "https://wso2apim.sys.ixdev.wso2.com"
        APIM_BROKER_HTTP_CLIENT_INSECURECON: (( .properties.http_client_insecure_con.value ))
        APIM_BROKER_HTTP_CLIENT_TIMEOUT: (( .properties.http_client_timeout.value ))
        APIM_BROKER_HTTP_CLIENT_MINBACKOFF: (( .properties.http_client_min_back_off.value ))
        APIM_BROKER_HTTP_CLIENT_MAXBACKOFF: (( .properties.http_client_max_back_off.value ))
        APIM_BROKER_HTTP_CLIENT_MAXRETRIES: (( .properties.http_client_max_retries.value ))
        APIM_BROKER_DB_HOST: (( .properties.db_host.value ))
        APIM_BROKER_DB_PORT: (( .properties.db_port.value ))
        APIM_BROKER_DB_DATABASE: (( .properties.db_database_name.value ))
        APIM_BROKER_DB_LOGMODE: (( .properties.db_logmode.value ))
        APIM_BROKER_DB_USERNAME: (( .properties.db_creds.identity ))
        APIM_BROKER_DB_PASSWORD: (( .properties.db_creds.password ))
        APIM_BROKER_HTTP_AUTH_USERNAME: (( .deploy-all.app_credentials.identity ))
        APIM_BROKER_HTTP_AUTH_PASSWORD: (( .deploy-all.app_credentials.password ))

